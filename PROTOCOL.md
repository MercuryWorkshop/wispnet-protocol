# WispNet Protocol

Version 1.0.0 Draft 1 written by @FoxMoss

## Notes

Previously what was called the client is now called the browser or a device. Do to the fact that a browser can now create a server and in many cases a browser is a client with another being a server.

## Packet Types

General Packet Types

| Field Name | Field Type | Notes                                                               |
|------------|------------|---------------------------------------------------------------------|
| Type       | uint8_t    | Types will mean different things coming from the server and browser |
| Payload    | ...        | Arbitrary data                                                      |


## Server Sent Packets

### 0x01 - REGISTERED
#### Format
| Field Name | Field Type | Notes                          |
|------------|------------|--------------------------------|
| Device ID  | uint32_t   | The id as stored on the server |

#### Behavior
Sent from the server right after connection, used by the browser to confirm a connection. An ID should be randomly generated and not conflict with another device. It can also be displayed as base64 on the browser for easy sharing and hostnames.

### 0x02 - REGISTRY
#### Format
| Field Name | Field Type | Notes                     |
|------------|------------|---------------------------|
| Sockets    | Socket[]   | Not seperated by anything |

#### Behavior
Sent by the server in response to a probe packet. Sends all discoverable ports on all devices.

#### Socket Struct
| Field Name | Field Type | Notes                                              |
|------------|------------|----------------------------------------------------|
| Device ID  | uint32_t   | Same as sent to client                             |
| Port       | uint16_t   | Fictional port to stay compliant with TCP          |
| Notes      | char[]     | Null terminated UTF-8 string defined by the client |

### 0x03 - FWD_CONNECT
#### Format

| Field Name    | Field Type | Notes                                                       |
|---------------|------------|-------------------------------------------------------------|
| Client ID     | uint32_t   | The ID of the browser that initiated connection             |
| Connection ID | uint32_t   | Generated by the server, specific to the socket & client ID |
| Stream Type   | uint8_t    | Same as the wisp packet                                     |
| Port          | uint16_t   | Same as the wisp packet.                                    |

#### Behavior
Forwarded from a tradional wisp CONNECT packet. Server should generate an incrementing or random connection ID and store the data on the stream for future use.

### 0x04 - FWD_DATA
#### Format
| Field Name    | Field Type | Notes                                           |
|---------------|------------|-------------------------------------------------|
| Client ID     | uint32_t   | The ID of the browser that initiated connection |
| Connection ID | uint32_t   | Same as in a FWD_CONNECT packet.                |
| Port          | uint16_t   | Same as the wisp packet.                        |
| Data          | ...        | Copied from wisp packet.                        |

#### Behavior
Forwarded from a tradional wisp DATA packet. Data should be reused from the connect packet that started the stream.

### 0x05 - FWD_EXIT
#### Format
| Field Name    | Field Type | Notes                                           |
|---------------|------------|-------------------------------------------------|
| Client ID     | uint32_t   | The ID of the browser that initiated connection |
| Connection ID | uint32_t   | Same as in a FWD_CONNECT packet.                |
| Port          | uint16_t   | Same as the wisp packet.                        |

#### Behavior
Sent when a wisp stream exits, or the device wisp websocket closes.

## Browser Sent Packets

### 0x01 - PROBE
#### Format
No body, sent as a single byte 0x01

#### Behavior
Sent to discover other devices on the Wisp Node. Once seen a server should respond with a `REGISTRY` packet.

### 0x02 - OPEN
#### Format

| Field Name   | Field Type          | Notes                                              |
|--------------|---------------------|----------------------------------------------------|
| Port         | uint16_t            | Fictional port to stay compliant with TCP          |
| Discoverable | bool (still a byte) | Wont be shown in a REGISTRY packet if false        |
| Notes        | char[]              | Null terminated UTF-8 string defined by the client |

#### Behavior
Sent to open a socket on the Wisp Node.

### 0x03 - SERVER_DATA
#### Format
| Field Name    | Field Type | Notes                                                  |
|---------------|------------|--------------------------------------------------------|
| Client ID     | uint32_t   | The ID of the browser that needs to receive the packet |
| Connection ID | uint32_t   | Same as the ID thats was sent to it.                   |
| Port          | uint16_t   | The port that is responding.                           |
| Data          | ...        | The raw stream data                                    |

#### Behavior
Packet should be forwarded to a client as a standard DATA packet once read by the Wisp Node.

### 0x05 - SERVER_EXIT
#### Format
| Field Name    | Field Type | Notes                                                  |
|---------------|------------|--------------------------------------------------------|
| Client ID     | uint32_t   | The ID of the browser that needs to receive the packet |
| Connection ID | uint32_t   | Same as the ID thats was sent to it.                   |
| Port          | uint16_t   | The port that is responding.                           |

#### Behavior
Packet should be forwarded to a client as a standard EXIT packet once read by the Wisp Node. This should be sent once all data has been sent.

# Wisp Changes

WispNet maintains backwards compatability with any standard wisp server, except parsing hostnames on CONNECT packets. If a connection is made for the `wispnet` hostname open a TCP stream to your own internal WispNet server as defined above. If the hostname ends with `.wisp` then interpret the begining section as a base64 encoded WispNet device ID.
